{% extends "base.html" %}

{% block title %}{{ property.address }} - Tourist Development Tax Collection{% endblock %}
{% block header %}Property Details{% endblock %}

{% block content %}
<div class="property-detail-layout">
<div class="property-main">
<div class="card">
    <div class="card-header">
        <h3>{{ property.address }}</h3>
        <div class="card-actions">
            <a href="{{ url_for('properties.edit_property', id=property.id) }}" class="btn btn-secondary">Edit</a>
            {% if not property.is_registered %}
            <form method="POST" action="{{ url_for('properties.register_property', id=property.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-primary">Register for TDT</button>
            </form>
            {% endif %}
        </div>
    </div>
    
    <div class="details-grid">
        <div class="detail-item">
            <span class="detail-label">City</span>
            <span class="detail-value">{{ property.city }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">ZIP Code</span>
            <span class="detail-value">{{ property.zip_code }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Parcel ID</span>
            <span class="detail-value">{{ property.parcel_id or 'Not assigned' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">TDT Number</span>
            <span class="detail-value">{{ property.tdt_number or 'Not registered' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Registration Status</span>
            <span class="detail-value">
                {% if property.is_registered %}
                    <span class="badge badge-success">Registered</span>
                {% else %}
                    <span class="badge badge-warning">Not Registered</span>
                {% endif %}
            </span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Registration Date</span>
            <span class="detail-value">{{ property.registration_date.strftime('%Y-%m-%d') if property.registration_date else '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Zoning</span>
            <span class="detail-value">{{ property.zoning_type | capitalize }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Homestead</span>
            <span class="detail-value">{{ 'Yes' if property.homestead_status else 'No' }}</span>
        </div>
        {% if property.lat and property.lng %}
        <div class="detail-item">
            <span class="detail-label">Coordinates</span>
            <span class="detail-value">{{ property.lat }}, {{ property.lng }}</span>
        </div>
        {% endif %}
    </div>
</div>
</div>

<div class="property-sidebar">
    <div class="card">
        <h3>Location</h3>
        {% if property.lat and property.lng %}
        <div id="property-map" class="property-map"></div>
        <p class="map-address">{{ property.address }}, {{ property.city }}, FL {{ property.zip_code }}</p>
        {% else %}
        <p class="empty-state">No location data available.</p>
        {% endif %}
    </div>
</div>
</div>

<div class="card">
    <h3>Payment History</h3>
    {% if property.payments %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Transaction ID</th>
                <th>Period</th>
                <th>Amount</th>
                <th>Dealer</th>
                <th>Payment Date</th>
                <th>Verified</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in property.payments %}
            <tr>
                <td><code>{{ payment.transaction_id }}</code></td>
                <td>{{ payment.period_start }} - {{ payment.period_end }}</td>
                <td>${{ "{:,.2f}".format(payment.amount) }}</td>
                <td>
                    {% if payment.dealer %}
                        <span class="badge badge-dealer">{{ payment.dealer.name }}</span>
                    {% else %}
                        <span class="badge badge-independent">Independent</span>
                    {% endif %}
                </td>
                <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else '-' }}</td>
                <td>{{ 'Yes' if payment.verified else 'No' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No payments recorded for this property.</p>
    {% endif %}
</div>

{% if property.lat and property.lng %}
<script>
function initMap() {
    const location = { lat: {{ property.lat }}, lng: {{ property.lng }} };
    const map = new google.maps.Map(document.getElementById('property-map'), {
        zoom: 16,
        center: location,
        mapTypeId: 'roadmap',
        disableDefaultUI: true,
        zoomControl: true
    });
    new google.maps.Marker({
        position: location,
        map: map,
        title: '{{ property.address }}'
    });
}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_API_KEY }}&callback=initMap"></script>
{% endif %}
{% endblock %}

