{% extends "base.html" %}

{% block title %}{{ property.address }} - Tourist Development Tax Collection{% endblock %}
{% block header %}Property Details{% endblock %}

{% block content %}
<div class="property-detail-layout">
<div class="property-main">
<div class="card">
    <div class="card-header">
        <h3>{{ property.address }}</h3>
        <div class="card-actions">
            <a href="{{ url_for('properties.edit_property', id=property.id) }}" class="btn btn-secondary">Edit</a>
            {% if not property.is_registered %}
            <form method="POST" action="{{ url_for('properties.register_property', id=property.id) }}" style="display: inline;">
                <button type="submit" class="btn btn-primary">Register for TDT</button>
            </form>
            {% endif %}
        </div>
    </div>
    
    <div class="details-grid">
        <div class="detail-item">
            <span class="detail-label">Owner</span>
            <span class="detail-value">{{ property.owner_name or '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">City</span>
            <span class="detail-value">{{ property.city }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">ZIP Code</span>
            <span class="detail-value">{{ property.zip_code }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Parcel ID</span>
            <span class="detail-value">{{ property.parcel_id or 'Not assigned' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">TDT Number</span>
            <span class="detail-value">{{ property.tdt_number or 'Not registered' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Registration Status</span>
            <span class="detail-value">
                {% if property.is_registered %}
                    <span class="badge badge-success">Registered</span>
                {% else %}
                    <span class="badge badge-warning">Not Registered</span>
                {% endif %}
            </span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Registration Date</span>
            <span class="detail-value">{{ property.registration_date.strftime('%Y-%m-%d') if property.registration_date else '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Zoning</span>
            <span class="detail-value">{{ property.zoning1 or property.zoning_type | capitalize }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Land Use Code</span>
            <span class="detail-value">{{ property.land_use_code or '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Neighborhood Code</span>
            <span class="detail-value">{{ property.neighborhood_code or '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Homestead</span>
            <span class="detail-value">{{ 'Yes' if property.homestead_status else 'No' }}</span>
        </div>
        {% if property.lat and property.lng %}
        <div class="detail-item">
            <span class="detail-label">Coordinates</span>
            <span class="detail-value">{{ property.lat }}, {{ property.lng }}</span>
        </div>
        {% endif %}
    </div>
    
    {% if property.legal_description1 %}
    <div style="margin-top: 1rem;">
        <h4>Legal Description</h4>
        <p>{{ property.legal_description1 }}</p>
        {% if property.legal_description2 %}
        <p>{{ property.legal_description2 }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>
</div>

<div class="property-sidebar">
    <div class="card">
        <h3>Location</h3>
        <div id="property-map" class="property-map"></div>
        <p class="map-address">{{ property.address }}, {{ property.city }}, FL {{ property.zip_code }}</p>
        {% if not property.lat or not property.lng %}
        <button id="geocode-btn" class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;">Get Location</button>
        {% endif %}
    </div>
</div>
</div>

<div class="card">
    <h3>Payment History</h3>
    {% if property.payments %}
    <table class="data-table">
        <thead>
            <tr>
                <th>Transaction ID</th>
                <th>Period</th>
                <th>Amount</th>
                <th>Dealer</th>
                <th>Payment Date</th>
                <th>Verified</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in property.payments %}
            <tr>
                <td><code>{{ payment.transaction_id }}</code></td>
                <td>{{ payment.period_start }} - {{ payment.period_end }}</td>
                <td>${{ "{:,.2f}".format(payment.amount) }}</td>
                <td>
                    {% if payment.dealer %}
                        <span class="badge badge-dealer">{{ payment.dealer.name }}</span>
                    {% else %}
                        <span class="badge badge-independent">Independent</span>
                    {% endif %}
                </td>
                <td>{{ payment.payment_date.strftime('%Y-%m-%d') if payment.payment_date else '-' }}</td>
                <td>{{ 'Yes' if payment.verified else 'No' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No payments recorded for this property.</p>
    {% endif %}
</div>

{% if property.values and property.values|length > 0 %}
<div class="card">
    <h3>Property Valuation</h3>
    {% set value = property.values[0] %}
    <div class="details-grid">
        <div class="detail-item">
            <span class="detail-label">Total Value</span>
            <span class="detail-value">${{ "{:,.2f}".format(value.total_value) if value.total_value else '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Land Value</span>
            <span class="detail-value">${{ "{:,.2f}".format(value.land_value) if value.land_value else '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Building Value</span>
            <span class="detail-value">${{ "{:,.2f}".format(value.building_value) if value.building_value else '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Assessed Value</span>
            <span class="detail-value">${{ "{:,.2f}".format(value.assessed_value) if value.assessed_value else '-' }}</span>
        </div>
        <div class="detail-item">
            <span class="detail-label">Taxable Value</span>
            <span class="detail-value">${{ "{:,.2f}".format(value.taxable_value) if value.taxable_value else '-' }}</span>
        </div>
    </div>
</div>
{% endif %}

{% if property.buildings and property.buildings|length > 0 %}
<div class="card">
    <h3>Building Information</h3>
    {% set building = property.buildings[0] %}
    <div class="details-grid">
        {% if building.year_built %}
        <div class="detail-item">
            <span class="detail-label">Year Built</span>
            <span class="detail-value">{{ building.year_built }}</span>
        </div>
        {% endif %}
        {% if building.full_bath %}
        <div class="detail-item">
            <span class="detail-label">Full Bathrooms</span>
            <span class="detail-value">{{ building.full_bath }}</span>
        </div>
        {% endif %}
        {% if building.half_bath %}
        <div class="detail-item">
            <span class="detail-label">Half Bathrooms</span>
            <span class="detail-value">{{ building.half_bath }}</span>
        </div>
        {% endif %}
        {% if building.primary_floors %}
        <div class="detail-item">
            <span class="detail-label">Floors</span>
            <span class="detail-value">{{ building.primary_floors }}</span>
        </div>
        {% endif %}
        {% if building.units %}
        <div class="detail-item">
            <span class="detail-label">Units</span>
            <span class="detail-value">{{ building.units }}</span>
        </div>
        {% endif %}
        {% if building.percent_air_conditioned %}
        <div class="detail-item">
            <span class="detail-label">Air Conditioning</span>
            <span class="detail-value">{{ building.percent_air_conditioned }}%</span>
        </div>
        {% endif %}
        {% if building.roof_cover %}
        <div class="detail-item">
            <span class="detail-label">Roof Cover</span>
            <span class="detail-value">{{ building.roof_cover }}</span>
        </div>
        {% endif %}
        {% if building.grade %}
        <div class="detail-item">
            <span class="detail-label">Grade</span>
            <span class="detail-value">{{ building.grade }}</span>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if property.sales and property.sales|length > 0 %}
<div class="card">
    <h3>Sales History</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Sale Date</th>
                <th>Sale Price</th>
                <th>Deed Type</th>
                <th>Legal Reference</th>
                <th>Recording Date</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in property.sales[:10] %}
            <tr>
                <td>{{ sale.sale_date.strftime('%Y-%m-%d') if sale.sale_date else '-' }}</td>
                <td>${{ "{:,.2f}".format(sale.sale_price) if sale.sale_price else '-' }}</td>
                <td>{{ sale.deed_type or '-' }}</td>
                <td>{{ sale.legal_reference or '-' }}</td>
                <td>{{ sale.recording_date.strftime('%Y-%m-%d') if sale.recording_date else '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if property.exemptions and property.exemptions|length > 0 %}
<div class="card">
    <h3>Tax Exemptions</h3>
    <table class="data-table">
        <thead>
            <tr>
                <th>Exemption Code</th>
                <th>Amount</th>
                <th>App Code</th>
            </tr>
        </thead>
        <tbody>
            {% for exemption in property.exemptions %}
            <tr>
                <td>{{ exemption.exemption_code }}</td>
                <td>${{ "{:,.2f}".format(exemption.amount_off_total_assessment) if exemption.amount_off_total_assessment else '-' }}</td>
                <td>{{ exemption.app_code or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<script>
let propertyMap = null;
let propertyMarker = null;
const propertyId = {{ property.id }};
const hasCoordinates = {% if property.lat and property.lng %}true{% else %}false{% endif %};
const initialLat = {% if property.lat %}{{ property.lat }}{% else %}null{% endif %};
const initialLng = {% if property.lng %}{{ property.lng }}{% else %}null{% endif %};
const propertyAddress = '{{ property.address }}, {{ property.city }}, FL {{ property.zip_code }}';

function initMap() {
    const mapElement = document.getElementById('property-map');
    if (!mapElement) {
        console.error('Map element not found');
        return;
    }

    if (hasCoordinates && initialLat && initialLng) {
        const location = { lat: initialLat, lng: initialLng };
        propertyMap = new google.maps.Map(mapElement, {
            zoom: 16,
            center: location,
            mapTypeId: 'roadmap',
            disableDefaultUI: true,
            zoomControl: true
        });
        propertyMarker = new google.maps.Marker({
            position: location,
            map: propertyMap,
            title: '{{ property.address }}'
        });
    } else {
        propertyMap = new google.maps.Map(mapElement, {
            zoom: 11,
            center: { lat: 27.3364, lng: -82.5307 },
            mapTypeId: 'roadmap',
            disableDefaultUI: true,
            zoomControl: true
        });
        geocodeAddress();
    }

    const geocodeBtn = document.getElementById('geocode-btn');
    if (geocodeBtn) {
        geocodeBtn.addEventListener('click', geocodeAddress);
    }
}

function geocodeAddress() {
    const geocodeBtn = document.getElementById('geocode-btn');
    if (geocodeBtn) {
        geocodeBtn.disabled = true;
        geocodeBtn.textContent = 'Loading...';
    }

    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({
        address: propertyAddress,
        bounds: new google.maps.LatLngBounds(
            { lat: 27.0, lng: -82.8 },
            { lat: 27.6, lng: -82.2 }
        )
    }, (results, status) => {
        if (status === 'OK' && results[0]) {
            const location = results[0].geometry.location;
            const lat = location.lat();
            const lng = location.lng();
            const placeId = results[0].place_id;

            if (propertyMap) {
                propertyMap.setCenter(location);
                propertyMap.setZoom(16);
            }

            if (propertyMarker) {
                propertyMarker.setPosition(location);
            } else {
                propertyMarker = new google.maps.Marker({
                    position: location,
                    map: propertyMap,
                    title: '{{ property.address }}'
                });
            }

            fetch(`/properties/${propertyId}/update-coordinates`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ lat: lat, lng: lng, place_id: placeId })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      if (geocodeBtn) {
                          geocodeBtn.style.display = 'none';
                      }
                      window.location.reload();
                  } else {
                      alert('Failed to save coordinates');
                      if (geocodeBtn) {
                          geocodeBtn.disabled = false;
                          geocodeBtn.textContent = 'Get Location';
                      }
                  }
              })
              .catch(error => {
                  console.error('Error:', error);
                  alert('Failed to save coordinates');
                  if (geocodeBtn) {
                      geocodeBtn.disabled = false;
                      geocodeBtn.textContent = 'Get Location';
                  }
              });
        } else {
            alert('Address not found. Please check the address and try again.');
            if (geocodeBtn) {
                geocodeBtn.disabled = false;
                geocodeBtn.textContent = 'Get Location';
            }
        }
    });
}
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initMap"></script>
{% endblock %}

